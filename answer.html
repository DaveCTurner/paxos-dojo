<!DOCTYPE html>
<html>
<head>
<script type='text/javascript'>

function runModule(url, cb) {
  var respond = function(message) {
    var req = new XMLHttpRequest();
    req.open('POST', url);
    req.setRequestHeader('Content-type', 'application/json');
    req.send(JSON.stringify(message));
  }

  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if (req.readyState != 4) {
      return;
    }

    var isHttpSuccess = 200 <= req.status && req.status <= 299;
    setTimeout(function() { runModule(url, cb) }, isHttpSuccess ? 0 : 2000);

    if (req.status == 200) {
      cb(JSON.parse(req.responseText), respond);
    }
  }
  req.open('GET', url);
  req.send();
}

learnerReceived = [];

runModule('http://localhost:8080/paxos/learner/javascript-dt/' + Math.random(), function(currMessage, respond) {
  console.log('learner currMessage: ' + JSON.stringify(currMessage));

  var haveLearned = false;
  learnerReceived.forEach(function(prevMessage) {
    if (!haveLearned && currMessage.timePeriod === prevMessage.timePeriod && currMessage.by != prevMessage.by) {
      console.log('learned value: \'' + currMessage.value + '\'');
      haveLearned = true;
    }
  });

  learnerReceived.push(currMessage);
});

proposerReceived = [];
latestProposedTimePeriod = 0;

runModule('http://localhost:8080/paxos/proposer/javascript-dt/' + Math.random(), function(currMessage, respond) {
  console.log('proposer currMessage: ' + JSON.stringify(currMessage));

  if (currMessage.timePeriod <= latestProposedTimePeriod) { return; }

  var haveProposed = false;
  proposerReceived.forEach(function(prevMessage) {
    if (haveProposed) { return; }
    if (currMessage.timePeriod != prevMessage.timePeriod) { return; }
    if (currMessage.by == prevMessage.by) { return; }

    var proposedValue = "Value from Javascript proposer";

    if (currMessage.lastAcceptedTimePeriod) {
      if (prevMessage.lastAcceptedTimePeriod) {
        if (currMessage.lastAcceptedTimePeriod > prevMessage.lastAcceptedTimePeriod) {
          proposedValue = currMessage.lastAcceptedValue;
        } else {
          proposedValue = prevMessage.lastAcceptedValue;
        }
      } else {
        proposedValue = currMessage.lastAcceptedValue;
      }
    } else if (prevMessage.lastAcceptedTimePeriod) {
        proposedValue = prevMessage.lastAcceptedValue;
    }

    respond({'type':'proposed','timePeriod':currMessage.timePeriod,'value':proposedValue});
    latestProposedTimePeriod = currMessage.timePeriod;
    haveProposed = true;
  });

  proposerReceived.push(currMessage);

});

maxAccepted = -1;
maxAcceptedValue = '';
maxPromised = -1;

runModule('http://localhost:8080/paxos/acceptor/brian', function(currMessage, respond) {
  console.log('acceptor currMessage: ' + JSON.stringify(currMessage));

  if (currMessage.type === 'prepare') {
    if (currMessage.timePeriod <= maxAccepted) { return; }
    if (currMessage.timePeriod > maxPromised) { maxPromised = currMessage.timePeriod; }
    
    currMessage.type = 'promised';
    currMessage.by   = 'brian';
    
    if (maxAccepted >= 0) {
      currMessage.lastAcceptedTimePeriod = maxAccepted;
      currMessage.lastAcceptedValue      = maxAcceptedValue;
    }
    respond(currMessage);
  
  } else if (currMessage.type === 'proposed') {
    if (currMessage.timePeriod < maxPromised) { return; }
    if (currMessage.timePeriod < maxAccepted) { return; }

    maxAccepted = currMessage.timePeriod;
    maxAcceptedValue = currMessage.value;

    currMessage.type = 'accepted';
    currMessage.by   = 'brian';
    respond(currMessage);
  }
  
});

</script>
</head>
<body>
Go and look at the JS console.
</body>
</html>

